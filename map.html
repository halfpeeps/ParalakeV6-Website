<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Paralake V6 Map Viewer</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    :root {
      --background: white;
      --sidebar-bg: #2c2c2c;
      --text: #f0f0f0;
      --accent: #007acc;
      --border: #444;
      --tag-bg: #444;
    }

    html, body {
      margin: 0;
      height: 100%;
      background: var(--background);
      font-family: "Segoe UI", sans-serif;
      color: var(--text);
      overflow: hidden;
    }

    #map-container {
      position: absolute;
      top: 0; bottom: 0; left: 0; right: 0;
      overflow: hidden;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    .leaflet-container {
      background: var(--background) !important;
    }

    .leaflet-control-zoom {
      z-index: 1100;
    }

    .custom-marker {
      background-color: var(--accent);
      border-radius: 50%;
      width: 16px;
      height: 16px;
      display: block;
      transform: translate(-50%, -50%);
    }

    #sidebar {
    position: absolute;
    top: 0;
    right: 0;
    width: 320px;
    height: 100%;
    background: var(--sidebar-bg);
    border-left: 1px solid var(--border);
    padding: 16px;
    overflow-y: auto;
    overflow-x: hidden;
    transform: translateX(100%);
    transition: transform 0.3s ease, opacity 0.3s ease;
    opacity: 0;
    z-index: 1000;
    box-sizing: border-box;
  }

  #sidebar.active {
    transform: translateX(0);
    opacity: 1;
  }

    #sidebar h2 {
      margin: 0 0 10px 0;
      font-size: 1.4em;
      color: var(--accent);
    }

    .tags span {
      display: inline-block;
      background: var(--tag-bg);
      color: #fff;
      padding: 3px 8px;
      border-radius: 4px;
      margin: 4px 4px 4px 0;
      font-size: 0.75em;
    }

    .location-image {
      width: 100%;
      margin-top: 10px;
      border-radius: 4px;
      border: 1px solid var(--border);
    }

    #editor-toggle {
      position: absolute;
      bottom: 50px;
      left: 10px;
      z-index: 1001;
      background: var(--sidebar-bg);
      color: var(--text);
      border: 1px solid var(--border);
      padding: 6px 10px;
      cursor: pointer;
      font-size: 14px;
      border-radius: 4px;
    }

    #editor-toggle:hover {
      background: var(--accent);
      color: #fff;
    }

    #back-button {
      position: absolute;
      bottom: 10px;
      left: 10px;
      z-index: 1001;
      background: var(--sidebar-bg);
      color: var(--text);
      border: 1px solid var(--border);
      padding: 6px 10px;
      cursor: pointer;
      font-size: 14px;
      border-radius: 4px;
      text-decoration: none;
    }

    #back-button:hover {
      background: var(--accent);
      color: #fff;
    }

    #sidebar-close {
      position: absolute;
      top: 10px;
      right: 10px;
      background: transparent;
      color: var(--text);
      border: none;
      font-size: 18px;
      cursor: pointer;
    }

    #tag-filter {
      position: absolute;
      top: 60px;
      left: 60px;
      z-index: 1002;
      background: var(--sidebar-bg);
      color: var(--text);
      border: 1px solid var(--border);
      padding: 10px;
      border-radius: 6px;
      max-height: 300px;
      overflow-y: auto;
      width: 200px;
      box-sizing: border-box;
    }

    #tag-filter label {
      display: block;
      margin-bottom: 4px;
      cursor: pointer;
    }

    #tag-directory-toggle {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 999;
    background: var(--sidebar-bg);
    color: var(--text);
    border: 1px solid var(--border);
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
  }

  #tag-directory-toggle:hover {
    background: var(--accent);
    color: white;
  }

  #tag-directory {
    position: absolute;
    top: 60px;
    right: 10px;
    width: 300px;
    max-height: 70%;
    background: var(--sidebar-bg);
    color: var(--text);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow-y: auto;
    padding: 12px;
    z-index: 1004;
    display: none;
  }

  .tag-card {
    background: #1e1e1e;
    border: 1px solid var(--border);
    border-radius: 6px;
    margin-bottom: 10px;
    padding: 10px;
  }

  .tag-card h3 {
    margin-top: 0;
    font-size: 1.1em;
    color: var(--accent);
  }

  .tag-card ul {
    list-style: none;
    padding-left: 0;
    margin: 0;
  }

  .tag-card li {
    padding: 4px 0;
    cursor: pointer;
    border-radius: 4px;
  }

  .tag-card li:hover {
    background: var(--accent);
    color: #fff;
  }

  #search-box {
    position: absolute;
    top: 10px;
    left: 60px;
    z-index: 1003;
    width: 240px;
    background: rgba(255, 255, 255, 0.1);
    color: var(--text);
    border: 1px solid var(--border);
    padding: 8px 14px;
    border-radius: 999px;
    font-size: 14px;
    outline: none;
    transition: background 0.2s, border-color 0.2s;
  }

  #search-box:focus {
    background: #fff;
    color: #000;
    border-color: var(--accent);
  }
  </style>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>
  <div id="map-container">
    <input type="text" id="search-box" placeholder="Search locations..." />
    <div id="map"></div>

      <div id="tag-filter">
        <strong style="display:block; margin-bottom: 6px;">Filter by Tag</strong>
      </div>

      <button id="tag-directory-toggle">ðŸ“‚ Open Directory</button>
      <div id="tag-directory">
        <div id="tag-directory-content"></div>
      </div>

      <a href="/Paralake-V6-Development-Archive/archive.html" id="back-button" title="Back to archive">Back</a>
      <button id="editor-toggle" style="display: none;">Enable Editor</button>

      <div id="sidebar">
        <button id="sidebar-close" title="Close sidebar">Ã—</button>
        <h2 id="location-name"></h2>
        <div class="tags" id="location-tags"></div>
        <p id="location-description"></p>
        <img id="location-image" class="location-image" />
    </div>
</div>

<script>
  const EDITOR_MODE = true;
  const bounds = [[0, 0], [0, 0]];
  const baseMap = L.imageOverlay('map_recourses/map.png', bounds);
  const satelliteMap = L.imageOverlay('map_recourses/map_sat.png', bounds);
  const map = L.map('map', {
    crs: L.CRS.Simple,
    minZoom: -2,
    maxZoom: 2,
    layers: [baseMap]
  });
  const baseLayers = {
    "Default View": baseMap,
    "Satellite View": satelliteMap
  };
  L.control.layers(baseLayers, null, { position: 'bottomright' }).addTo(map);
  
  const tagColors = {};
  const markers = [];
  
  function getScaleFromZoom(zoom) {
    return 1 + zoom * 0.3;
  }
  
  function colorizeIcon(imgSrc, colorHex, scale = 1, callback) {
    const img = new Image();
    img.crossOrigin = "Anonymous";
    img.onload = function () {
      const baseSize = 32 * scale;
      const iconSize = Math.max(40, baseSize);
      const padding = 12 * scale;
      const size = iconSize + padding * 2;
  
      const canvas = document.createElement("canvas");
      canvas.width = size;
      canvas.height = size;
      const ctx = canvas.getContext("2d");
  
      const center = size / 2;
      const radius = iconSize / 2 + padding / 2;
  
      ctx.beginPath();
      ctx.arc(center, center, radius + 6, 0, 2 * Math.PI);
      ctx.fillStyle = colorHex + '55';
      ctx.fill();
  
      ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
      ctx.shadowBlur = 4;
      ctx.shadowOffsetX = 1;
      ctx.shadowOffsetY = 1;
  
      ctx.beginPath();
      ctx.arc(center, center, radius, 0, 2 * Math.PI);
      ctx.fillStyle = '#fff';
      ctx.fill();
  
      ctx.strokeStyle = '#000';
      ctx.lineWidth = 2 * scale;
      ctx.stroke();
  
      const tempCanvas = document.createElement("canvas");
      tempCanvas.width = iconSize;
      tempCanvas.height = iconSize;
      const tempCtx = tempCanvas.getContext("2d");
  
      tempCtx.drawImage(img, 0, 0, iconSize, iconSize);
      tempCtx.globalCompositeOperation = "source-in";
      tempCtx.fillStyle = colorHex || 'gray';
      tempCtx.fillRect(0, 0, iconSize, iconSize);
  
      ctx.drawImage(tempCanvas, padding, padding);
  
      callback(canvas.toDataURL());
    };
    img.src = imgSrc;
  }
  
  function showSidebar(location) {
    document.getElementById('location-name').textContent = location.name;
    const tags = document.getElementById('location-tags');
    tags.innerHTML = '';
    location.tags.forEach(tag => {
      const span = document.createElement('span');
      span.textContent = tag;
      span.style.backgroundColor = tagColors[tag] || 'gray';
      tags.appendChild(span);
    });
    document.getElementById('location-description').textContent = location.description;
    document.getElementById('location-image').src = location.image;
    document.getElementById('sidebar').classList.add('active');
  }
  
  document.getElementById('sidebar-close').addEventListener('click', () => {
    document.getElementById('sidebar').classList.remove('active');
  });
  
  document.getElementById('search-box').addEventListener('input', () => {
    const query = document.getElementById('search-box').value.toLowerCase();
    markers.forEach(marker => {
      const b = marker.metaData;
      const match =
        b.name.toLowerCase().includes(query) ||
        b.tags.some(t => t.toLowerCase().includes(query)) ||
        (b.description && b.description.toLowerCase().includes(query));
      marker[match ? 'addTo' : 'removeFrom'](map);
    });
  });
  
  const mapImage = new Image();
  mapImage.src = 'map_recourses/map.png';
  mapImage.onload = () => {
    const w = mapImage.width;
    const h = mapImage.height;
    bounds[1] = [h, w];
    baseMap.setBounds(bounds);
    satelliteMap.setBounds(bounds);
    map.setMaxBounds(bounds);
    map.fitBounds(bounds);
  
    Promise.all([
      fetch('/map_recourses/locations.json').then(res => res.json()),
      fetch('/map_recourses/tags.json').then(res => res.json())
    ]).then(([locations, tags]) => {
      tags.forEach(t => tagColors[t.name] = t.color);
      const usedPrimaryTags = new Set(locations.map(loc => loc.primaryTag));
      const tagFilter = document.getElementById('tag-filter');
      const activeTags = new Set();
  
      tags.forEach(t => {
        if (!usedPrimaryTags.has(t.name)) return;
        activeTags.add(t.name);
  
        const label = document.createElement('label');
        label.innerHTML = `<input type="checkbox" value="${t.name}" checked> ${t.name}`;
        const checkbox = label.querySelector('input');
        checkbox.addEventListener('change', () => {
          if (checkbox.checked) {
            activeTags.add(t.name);
          } else {
            activeTags.delete(t.name);
          }
  
          markers.forEach(marker => {
            const b = marker.metaData;
            const isVisible = activeTags.has(b.primaryTag);
            marker[isVisible ? 'addTo' : 'removeFrom'](map);
          });
        });
        tagFilter.appendChild(label);
      });
  
      const tagDirectoryContent = document.getElementById('tag-directory-content');
      usedPrimaryTags.forEach(tagName => {
        const tagCard = document.createElement('div');
        tagCard.className = 'tag-card';
  
        const header = document.createElement('h3');
        header.textContent = tagName;
        header.style.color = tagColors[tagName] || 'white';
        tagCard.appendChild(header);

  
        const list = document.createElement('ul');
  
        locations
          .filter(loc => loc.primaryTag === tagName)
          .forEach(loc => {
            const item = document.createElement('li');
            item.textContent = loc.name;
            item.addEventListener('click', () => {
              document.getElementById('tag-directory').style.display = 'none';
              const marker = markers.find(m => m.metaData === loc);
              if (marker) {
                map.setView([loc.y, loc.x], map.getZoom());
                marker.fire('click');
              }
            });
            list.appendChild(item);
          });
  
        tagCard.appendChild(list);
        tagDirectoryContent.appendChild(tagCard);
      });
  
      const tagDirectory = document.getElementById('tag-directory');
      let tagDirectoryVisible = false;

      document.getElementById('tag-directory-toggle').addEventListener('click', () => {
        tagDirectoryVisible = !tagDirectoryVisible;
        tagDirectory.style.display = tagDirectoryVisible ? 'block' : 'none';
      });

  
      const scale = getScaleFromZoom(map.getZoom());
  
      locations.forEach(b => {
        const color = tagColors[b.primaryTag] || 'gray';
        if (b.icon && b.primaryTag) {
          colorizeIcon(b.icon, color, scale, (tintedSrc) => {
            const size = 32 * scale;
            const icon = L.icon({
              iconUrl: tintedSrc,
              iconSize: [size, size],
              iconAnchor: [size / 2, size / 2]
            });
            placeMarker(b, icon);
          });
        } else {
          const icon = L.divIcon({
            className: 'custom-marker',
            iconSize: [16, 16]
          });
          placeMarker(b, icon);
        }
      });
  
      function placeMarker(b, icon) {
        const marker = L.marker([b.y, b.x], { icon, title: b.name }).addTo(map);
        marker.metaTags = b.tags;
        marker.metaData = b;
        marker.on('click', () => showSidebar(b));
        markers.push(marker);
      }
  
      if (EDITOR_MODE) {
        const toggle = document.getElementById('editor-toggle');
        toggle.style.display = 'block';
        let editorEnabled = false;
        toggle.addEventListener('click', () => {
          editorEnabled = !editorEnabled;
          toggle.textContent = editorEnabled ? 'Disable Editor' : 'Enable Editor';
          document.getElementById('map').style.cursor = editorEnabled ? 'crosshair' : 'grab';
  
          if (editorEnabled) {
            map.once('click', e => {
              const x = Math.round(e.latlng.lng);
              const y = Math.round(e.latlng.lat);
              const json = {
                name: "New location",
                x: x,
                y: y,
                tags: ["Tag"],
                primaryTag: "Tag",
                description: "Description here.",
                image: "map_recourses/images/image.jpg",
                icon: "map_recourses/icons/icon.png"
              };
              console.log(JSON.stringify(json, null, 2));
              alert('Marker data copied to console!');
            });
          }
        });
      }
  
      map.on('zoomend', () => {
        const zoom = map.getZoom();
        const scale = getScaleFromZoom(zoom);
  
        markers.forEach(marker => {
          const data = marker.metaData;
          const color = tagColors[data.primaryTag] || 'gray';
  
          if (data.icon && data.primaryTag) {
            colorizeIcon(data.icon, color, scale, (tintedSrc) => {
              const size = 34 * scale;
              const icon = L.icon({
                iconUrl: tintedSrc,
                iconSize: [size, size],
                iconAnchor: [size / 2, size / 2]
              });
              marker.setIcon(icon);
            });
          }
        });
      });
    });
  };
</script>
  

</body>
</html>
